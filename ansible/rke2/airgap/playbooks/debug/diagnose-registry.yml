---
- name: Diagnose Private Registry Issues on Bastion Host
  hosts: bastion
  gather_facts: true
  become: true
  tasks:
    - name: Check Docker service status
      ansible.builtin.systemd:
        name: docker
      register: docker_status

    - name: Display Docker service status
      ansible.builtin.debug:
        var: docker_status

    - name: Check if Docker is running
      ansible.builtin.command: systemctl is-active docker
      register: docker_active
      failed_when: false
      changed_when: false

    - name: Display Docker active status
      ansible.builtin.debug:
        msg: "Docker is {{ docker_active.stdout }}"

    - name: List running Docker containers
      ansible.builtin.command: docker ps -a
      register: docker_containers
      failed_when: false
      changed_when: false

    - name: Display Docker containers
      ansible.builtin.debug:
        msg: |
          Docker Containers:
          {{ docker_containers.stdout }}

    - name: Check registry container specifically
      ansible.builtin.command: docker ps -f name=registry
      register: registry_container
      failed_when: false
      changed_when: false

    - name: Display registry container status
      ansible.builtin.debug:
        msg: |
          Registry Container:
          {{ registry_container.stdout }}

    - name: Check registry container logs (last 50 lines)
      ansible.builtin.command: docker logs --tail 50 registry
      register: registry_logs
      failed_when: false
      changed_when: false

    - name: Display registry logs
      ansible.builtin.debug:
        msg: |
          Registry Logs (last 50 lines):
          {{ registry_logs.stdout }}
          {{ registry_logs.stderr }}

    - name: Check if port 5000 is listening
      ansible.builtin.command: netstat -tlnp | grep :5000
      register: port_5000
      failed_when: false
      changed_when: false

    - name: Display port 5000 status
      ansible.builtin.debug:
        msg: |
          Port 5000 Status:
          {{ port_5000.stdout }}

    - name: Test registry health endpoint locally
      ansible.builtin.uri:
        url: "http://localhost:5000/v2/"
        method: GET
        timeout: 10
      register: registry_health_local
      failed_when: false

    - name: Display local registry health
      ansible.builtin.debug:
        msg: |
          Local Registry Health:
          Status: {{ registry_health_local.status | default('Failed') }}
          Response: {{ registry_health_local.json | default('No response') }}
          Error: {{ registry_health_local.msg | default('No error') }}

    - name: Test registry health endpoint via external IP
      ansible.builtin.uri:
        url: "http://{{ ansible_default_ipv4.address }}:5000/v2/"
        method: GET
        timeout: 10
      register: registry_health_external
      failed_when: false

    - name: Display external registry health
      ansible.builtin.debug:
        msg: |
          External Registry Health:
          Status: {{ registry_health_external.status | default('Failed') }}
          Response: {{ registry_health_external.json | default('No response') }}
          Error: {{ registry_health_external.msg | default('No error') }}

    - name: Check firewall status
      ansible.builtin.command: ufw status
      register: firewall_status
      changed_when: false
      ignore_errors: true

    - name: Display firewall status
      ansible.builtin.debug:
        msg: |
          Firewall Status:
          {{ firewall_status.stdout }}

    - name: Check iptables rules
      ansible.builtin.command: iptables -L -n
      register: iptables_rules
      changed_when: false

    - name: Display iptables rules
      ansible.builtin.debug:
        msg: |
          IPTables Rules:
          {{ iptables_rules.stdout }}

    - name: Check registry directory structure
      ansible.builtin.command: ls -la /opt/registry/
      register: registry_dirs
      changed_when: false

    - name: Display registry directory structure
      ansible.builtin.debug:
        msg: |
          Registry Directory Structure:
          {{ registry_dirs.stdout }}

    - name: Check registry data directory
      ansible.builtin.command: ls -la /opt/registry/data/
      register: registry_data
      changed_when: false

    - name: Display registry data directory
      ansible.builtin.debug:
        msg: |
          Registry Data Directory:
          {{ registry_data.stdout }}

    - name: Check if registry images exist
      ansible.builtin.command: find /opt/registry/data -name "*.json" -o -name "*.tar" | head -10
      register: registry_images
      changed_when: false

    - name: Display registry images
      ansible.builtin.debug:
        msg: |
          Registry Images (first 10):
          {{ registry_images.stdout }}

- name: Test Registry Connectivity from Airgap Nodes
  hosts: airgap_nodes
  gather_facts: true
  become: false
  tasks:
    - name: Get bastion host IP
      ansible.builtin.set_fact:
        bastion_ip: "{{ hostvars[groups['bastion'][0]]['ansible_default_ipv4']['address'] | default(hostvars[groups['bastion'][0]]['ansible_host']) }}"

    - name: Test private registry health endpoint
      ansible.builtin.uri:
        url: "http://{{ hostvars[groups['bastion'][0]]['ansible_host'] }}:5000/v2/"
        method: GET
        timeout: 10
      register: registry_health
      failed_when: false

    - name: Display registry connectivity from airgap
      ansible.builtin.debug:
        msg: |
          Registry Connectivity from {{ inventory_hostname }} to {{ bastion_ip }}:5000:
          Status: {{ registry_connectivity.status | default('Failed') }}
          Error: {{ registry_connectivity.msg | default('No error') }}

    - name: Test DNS resolution of registry hostname
      ansible.builtin.command: nslookup {{ bastion_host }}
      register: dns_resolution
      changed_when: false

    - name: Display DNS resolution
      ansible.builtin.debug:
        msg: |
          DNS Resolution for {{ bastion_host }}:
          {{ dns_resolution.stdout }}

    - name: Test network connectivity to bastion port 5000
      ansible.builtin.command: nc -zv {{ bastion_ip }} 5000
      register: nc_test
      changed_when: false

    - name: Display network connectivity test
      ansible.builtin.debug:
        msg: |
          Network Connectivity Test to {{ bastion_ip }}:5000:
          {{ nc_test.stdout }}
          {{ nc_test.stderr }}
